<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .move-btn {
            padding: 20px;
            color :#fff;
            background: #689ae2;
            border: none;
        }
        #calendar th, #calendar td {
            padding: 20px;
        }
        .today {
            background: #0a53be;
            color: #fff;
            cursor: pointer;
        }
        .month-date {
            font-weight: 600;
            padding-left: 10px;
        }
        .select-date {
            cursor: pointer;
        }
        .todo-list-box {
            position: absolute;
            top :50%;
            left: 50%;
            width: 500px;
            margin-top: -250px;
            margin-left: -250px;
            background: #fff;
            border: 1px solid #000;
            display: none;
            padding: 20px;
        }
        .close-btn {
            position: absolute;
            top: 0px;
            right: 0px;
            margin: 10px;
        }
        .todo-date {
            font-weight: 600;
        }
        .submit {
            padding: 10px 20px;
            vertical-align: middle;
            margin-left: 20px;
        }
    </style>
</head>
<body>
    <div id="calendar-box">
        <div class="btn-box">
            <button id="prev" class="move-btn">이전</button>
            <span id="now"></span>
            <button id="next" class="move-btn">다음</button>
            <button type="button" class="today-btn move-btn">오늘 날짜</button>
        </div>
        <div id="calendar"></div>
        <div class="todo-list-box">
            <h1>TODO-LIST</h1>
            <p class="todo-date"></p>
            <div class="search"></div>
            <div class="result-list">
            </div>
            <button type="button" class="close-btn">닫기</button>
        </div>
    </div>
    <script src="https://momentjs.com/downloads/moment.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const $calendar =  document.querySelector("#calendar");
        const $now =  document.querySelector("#now");
        const $todoListBox = document.querySelector(".todo-list-box");
        const $todoDate = document.querySelector(".todo-date");
        const $ul = document.createElement("ul");
        const $search = document.querySelector(".search");

        let date = new Date();
        let today = new Date();

        function showCalendar(today) {
            console.log(date);
            let year = today.getFullYear();
            let month = today.getMonth();

            // 년 표시
            const yearDate = document.createElement("span");
            yearDate.append(year + "년");
            yearDate.className = "year-date";

            // 월 표시
            const monthDate = document.createElement("span");
            monthDate.append(month+1 + "월");
            monthDate.className = "month-date";

            // now에 요일 추가
            month.className = "month";
            $now.append(yearDate);
            $now.append(monthDate);

            // 1일의 요일 구하기
            let firstDay = new Date(today.getFullYear(), today.getMonth(), 1).getDay();

            // 테이블 생성, 클래스 네임 부여
            const $table = document.createElement("table");
            $table.className = "calendar-tbl";

            // 요일
            const weekDays = ["일", "월", "화", "수", "목", "금", "토"];
            const $thead = document.createElement("thead");
            let $tr1 = document.createElement("tr");
            for (let i = 0; i < weekDays.length; i++) {
                const $th = document.createElement("th");
                $th.append(weekDays[i]);
                $tr1.append($th);
            }
            $thead.append($tr1);

            const $tbody = document.createElement("tbody");

            // 마지막 날
            const lastDays = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

            // 윤년 구하기
            if ((year%4 === 0) && year % 100 != 0 || year % 400 == 0) {
                lastDays[1] = 29;
            }

            // 6주, 7일마다 tr 추가 줄바꾸기
            let todayDate;
            let cnt = 1;
            for(let i = 0; i < 6; i++) {
                let $tr = document.createElement('tr');
                for(let j = 0; j < 7; j++) {
                    if ((i === 0 && j < firstDay || cnt > lastDays[date.getMonth()])) {
                        let $td = document.createElement('td');
                        $tr.appendChild($td);
                    } else {
                        let $td = document.createElement('td');
                        $td.append(cnt);
                        $td.className = "select-date";
                        $tr.appendChild($td);
                        cnt++;

                        // 오늘 날짜 표시
                        if( today.getFullYear() == date.getFullYear() && today.getMonth() == date.getMonth() && cnt-1==date.getDate() )
                        {
                            $td.classList.add("today");
                        }
                    }
                }
                $tbody.append($tr);
            }

            $table.append($thead);
            $table.append($tbody);
            $calendar.append($table);

            let selectDate = $(".select-date");

            // // 각각의 날짜 클릭
            selectDate.on("click", function() {
                const date = new Date(today.getFullYear(), today.getMonth()-1, this.innerHTML);
                const formateDate  = moment(date).format("YYYYMMDD");
                selectDate.removeClass("active");
                $(this).addClass("active");
                // initial todo list
                $(".result-list ul").empty();
                $search.textContent = "";
                if ($(this).hasClass("active")) {
                    todoList(today, this);
                }

            });

        }

        // todoList 로직
        function todoList(today, $td) {
            const date = new Date(today.getFullYear(), today.getMonth()-1, $td.innerHTML);
            const formateDate  = moment(date).format("YYYYMMDD");
            $todoDate.textContent = formateDate;
            // todoList 박스 띄우기
            $todoListBox.style.display = "block";
            readLocalStorage(formateDate);
        }

        let dateLists = [];
        let name;
        // Save localStorage
        function saveLocalStorage(nowDate, inputValue) {
            if (localStorage.getItem("list")) {
                dateLists = JSON.parse(localStorage.getItem("list"));
            }

            // check for selected data
            if(dateLists.length == 0 || !fnCheckDate(nowDate)) {
                // is not exist
                dateLists.push({
                    "date" : nowDate,
                    todoList : [{
                        "key" : 1,
                        "content" : inputValue,
                        "delete" : "N"
                    }]
                });
            } else {
                // exist
                dateLists.forEach(function(item) {
                    // find selected data
                    if (item.date == nowDate) {
                        // push data
                        item.todoList.push({
                            "key" : item.todoList.length + 1,
                            "content" : inputValue,
                            "delete" : "N"
                        });
                    }
                });
            }

            localStorage.setItem("list",JSON.stringify(dateLists));
        }

        // read localStorage
        let list = [];
        function readLocalStorage(nowDate) {
            const $resultList = document.querySelector(".result-list");
            // ul, li, input, button 추가
            const $input = document.createElement("input");
            // 리스트 추가 버튼
            $input.className = "add-list";
            const $addTodo = document.createElement("button");
            $addTodo.className = "submit";
            $addTodo.innerHTML = "추가";

            $addTodo.addEventListener("click", function() {
                let inputValue = $input.value;
                // 로컬 스토리지에 저장
                saveLocalStorage(nowDate, inputValue);
                // read Storage
                fnTodoListBySelectedDate(nowDate);
            });

            $resultList.append($ul);
            $input.setAttribute("type", "text");
            $search.append($input);
            $search.append($addTodo);

            fnTodoListBySelectedDate(nowDate);
        }

        function fnTodoListBySelectedDate(nowDate) {
            const $resultList = document.querySelector(".result-list");
            $(".result-list ul").empty();

            list = JSON.parse(localStorage.getItem("list"));
            // list 요소 하나하나 가져와서 read
            if (list != undefined) {
                list.forEach(function (item) {
                    if (item.date == nowDate) {
                        for (let i = 0; i < item.todoList.length; i++) {
                            if (item.todoList[i].delete == "N") {
                                const $li = fnMakeDeleteButton();
                                $li.append(item.todoList[i].content);
                                $li.id = item.todoList[i].key;
                                $ul.append($li);
                            }
                        }
                    }

                });
            }
            $resultList.append($ul);

            // delete todo
            $(".delete-btn").click(function (event) {
                fnDeleteTodo($(this));
            });

        }

        // make deleteButton
        function fnMakeDeleteButton() {
            const $li = document.createElement("li");
            const $button = document.createElement("button");
            $button.textContent = "삭제";
            $button.className = "delete-btn";
            $li.append($button);

            return $li;
        }

        function fnCheckDate(_selectDate) {
            let isExist = false;
            dateLists.forEach(function(item) {
                if (item.date == _selectDate) {
                    isExist = true;
                };
            });

            return isExist;
        }

        function fnDeleteTodo($_obj) {
            // find a selected date
            let selectedDate = $_obj.closest(".todo-list-box").find(".todo-date").text().trim();
            let $li = $_obj.closest("li");
            let id = $li.attr("id");

            list.forEach(function(item) {
                // selected date
                if (item.date == selectedDate) {
                    // find a todo list
                    $.each(item.todoList, function (i, e) {
                        if(e.key == id) {
                            e.delete = "Y";
                        }
                        if (e.delete == "Y") {
                            $li.remove();
                        }
                    });
                }

            });
            localStorage.setItem("list",JSON.stringify(list));
        }

        // 달력 보기
        showCalendar(date);

        // 이전 버튼
        const $prev = document.querySelector("#prev").addEventListener("click", function(){
            console.log("이전버튼");
            today = new Date(today.getFullYear(), today.getMonth()-1, today.getDate());
            $calendar.textContent = "";
            $now.textContent = "";
            $todoListBox.style.display = "none";
            showCalendar(today);
        });

        // 다음 버튼
        const $next = document.querySelector("#next").addEventListener("click", function() {
            console.log("다음버튼");
            today = new Date(today.getFullYear(), today.getMonth()+1, today.getDate());
            $calendar.textContent = "";
            $now.textContent = "";
            $todoListBox.style.display = "none";
            showCalendar(today);
        });

        document.querySelector(".today").addEventListener("click", function() {
            console.log("오늘");
        });

        document.querySelector(".close-btn").addEventListener("click", function() {
            $todoListBox.style.display = "none";
        });

        document.querySelector('.today-btn').addEventListener("click", function() {
            console.log("오늘날짜" + today);
            $calendar.textContent = "";
            $now.textContent = "";
            $todoListBox.style.display = "none";
            showCalendar(date);
        });

    </script>
</body>
</html>